<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_caci_cisco_inter.Cisco_AppUtil</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <name>Cisco_AppUtil</name>
        <script><![CDATA[var Cisco_AppUtil = Class.create();
Cisco_AppUtil.prototype = {
	
	initialize: function() {
		this.logger = new Cisco_SNLogger();
		
		this.configuration = {
			
			"api" : {
				"fetchServers" : "/compute/PhysicalSummaries?",
				"fetchFIs" : "/network/ElementSummaries?",
				"fetchAlarms" : "/cond/Alarms?$filter=(Severity%20ne%20%27Cleared%27)&",
				"fetchHX" : "/hyperflex/Clusters?",
				"deviceRegistration" : '/asset/DeviceRegistrations?'
			},
			
			"property" : {
				"apiPrefix" : gs.getProperty('x_caci_cisco_inter.api.prefix')+'',
				"authSysId" : gs.getProperty('x_caci_cisco_inter.authentication.record.sysid')+''
			}
		};
	},
	
	makeApiCall: function(method, endpoint, body, intersightAccount) {
		
		try{
			this.logger.debug("Inside Cisco_AppUtil.makeApiCall performing API call to endpoint " + endpoint);
			
			var sigCompute = new Cisco_SignatureCompute();
			
			var secretKey = intersightAccount.secret_key+'';
			var keyId = intersightAccount.api_key_id+'';
			
			var prefix = this.configuration.property.apiPrefix+'';
			var host = intersightAccount.host_name+'';
			
			var currDate = new Date().toGMTString();
			
			var midServerName = intersightAccount.mid_server.name + '';
			
			var midServerStatus = intersightAccount.mid_server.status + '' ;
			var midServerValidated = intersightAccount.mid_server.validated + '' ;
			
			var url = "https://" + host + prefix + endpoint;
			
			var computedDigest = sigCompute.computeDigest(body);
			var hash = sigCompute.hash(prefix + endpoint, host, computedDigest, method, currDate, secretKey);
			var signature = sigCompute.signature(hash);
			
			var authorization='Signature '+
			'keyId="' + keyId + '",' +
			'algorithm="rsa-sha256",' +
			'headers="(request-target) date digest host",' +
			'signature="' + signature + '"';
			var mid_flag = 0 ;
			if( intersightAccount.on_premises &&   midServerStatus == 'Down' &&  midServerValidated == 'false' ) {
				this.logger.error("mid Server is Down and its Not validated ,Please check your Connection" );
				mid_flag = 1;
				
				
			}
			else if( intersightAccount.on_premises  &&  midServerStatus == 'Down' && midServerValidated == 'true' ) {
				this.logger.error("mid Server is Down ,Please check your Connection" );
				mid_flag = 1;
			}
			
			else if( intersightAccount.on_premises  &&  midServerStatus == 'Up' && midServerValidated == 'false' ) {
				this.logger.error("mid Server is Up but its Not validated ,Please check your Connection" );
				mid_flag = 1;
			}
			if(mid_flag == 0){
				var request = new sn_ws.RESTMessageV2();
				request.setEndpoint(url);
				request.setHttpMethod(method);
				if(midServerName  && intersightAccount.on_premises){
					request.setMIDServer(midServerName);
				}
				request.setRequestHeader("Accept", 'application/json');
				request.setRequestHeader('Authorization', authorization);
				request.setRequestHeader('Digest', computedDigest);
				request.setRequestHeader('Date', currDate);
				
				var response = request.execute();
				return response;
				
			}
		}catch(e){
			this.logger.error("Exception caught inside Cisco_AppUtil.makeApiCall while making API call to " + endpoint + ". Error :- "+e);
		}
	},
	
	parse: function(str){
		
		if(str)
			return JSON.parse(str);
		
		return '';
	},
	
	stringify: function(str){
		
		if(str)
			return JSON.stringify(str);
		
		return '';
	},
	
	type: 'Cisco_AppUtil'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>girishgyani</sys_created_by>
        <sys_created_on>2019-02-12 08:36:13</sys_created_on>
        <sys_id>25ab79cedb6b230062a3d450cf9619e3</sys_id>
        <sys_mod_count>83</sys_mod_count>
        <sys_name>Cisco_AppUtil</sys_name>
        <sys_package display_value="Cisco Intersight ITSM Plugin" source="x_caci_cisco_inter">baef2ff5db132300d7b59235ca9619e3</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Cisco Intersight ITSM Plugin">baef2ff5db132300d7b59235ca9619e3</sys_scope>
        <sys_update_name>sys_script_include_25ab79cedb6b230062a3d450cf9619e3</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2019-12-05 11:22:32</sys_updated_on>
    </sys_script_include>
</record_update>
